#!/bin/bash


source config

proftpd=${FTPINSTALLDIR}/sbin/proftpd
localperf=/home/dop/Downloads/linux/tools/perf/perf

[[ "$EUID" -eq 0 ]] && fail "Pleasd do NOT run as root"

echo "killing any existing proftpd processes"
sudo killall proftpd
sudo killall -9 proftpd 2> /dev/null

echo "resetting ${FTPHOME}"
sudo rm -rf $FTPHOME
sudo mkdir $FTPHOME
sudo mkdir $FTPHOME/etc
echo "other password required /pam_bla.so" | sudo tee ${FTPHOME}/etc/pam.conf
sudo chown ftptest:ftptest $FTPHOME
sudo chown -R ftptest:ftptest ${FTPHOME}/*

RANDOMIZE_VA_SPACE=$(cat /proc/sys/kernel/randomize_va_space)
echo $RANDOMIZE_VA_SPACE
#say "diabling /proc/sys/kernel/randomize_va_space (was ${RANDOMIZE_VA_SPACE})"
#echo 0 | sudo tee /proc/sys/kernel/randomize_va_space

echo "starting ${proftpd}"
sudo $proftpd


read -n 1 -s -r -p "Press any key to continue"   #cl add

#here perf proftpd
#$localperf record -e intel_pt//u -p `pidof proftpd`
#say "$localperf record -e intel_pt//u -p `pidof proftpd`"
# echo "dropping sudo privileges"
# sudo -k

echo "staring msfconsole to run exploit"
# Try to run using available msfconsole command
if command -v /home/dop/Downloads/metasploit-framework/msfconsole >/dev/null 2>&1; then
	echo "Using exisitng msfconsole command"
	/home/dop/Downloads/metasploit-framework/msfconsole -r ${SCRIPT_FILE}
elif [[ -e ${CUSTOM_MSFCONSOLE} ]]; then
	# assume we might need rvm
	if [[ -s "$HOME/.rvm/scripts/rvm" ]]; then
		echo "Loading RVM"
		source "$HOME/.rvm/scripts/rvm"
		export PATH="${HOME}/.rvm/bin:${PATH}" # Add RVM to PATH for scripting
	fi
	echo "Loading msfconsole at ${SCRIPT_FILE}"
	pushd "${CUSTOM_MSFCONSOLE}"
	./msfconsole -r ${SCRIPT_FILE}
	popd
else
	echo "Cannot find msfconsole to run"
fi

echo "kill proftpd"
sudo killall proftpd
sudo killall -9 proftpd 2> /dev/null

say "setting /proc/sys/kernel/randomize_va_space back to ${RANDOMIZE_VA_SPACE})"
echo ${RANDOMIZE_VA_SPACE} | sudo tee /proc/sys/kernel/randomize_va_space
